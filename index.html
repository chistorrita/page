<style>
/* Estilo para el estado de Deuda y Racha */
.status-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: 5px; font-weight: bold; }
.deuda { background: #ff4444; color: white; }
.racha-fuego { background: orange; color: black; animation: shake 0.5s infinite; display: inline-block; }
@keyframes shake { 0% {transform: rotate(0deg);} 50% {transform: rotate(5deg);} 100% {transform: rotate(0deg);} }

/* Estilo para el Ã­tem del seguro en la tienda */
.seguro-active { border: 2px solid #00ff00 !important; box-shadow: 0 0 10px #00ff00; }
</style>

<div id="shop-modal" class="modal">
    <h3 style="color:gold; margin-top:0;">Tienda Chistorrita</h3>
    <div class="shop-item">
        <p style="margin:0; font-weight:bold; color:var(--accent);">ğŸ”¥ Multiplicador x2</p>
        <button id="buy-x2" onclick="buyMultiplier()" style="background:gold; color:black; margin-top:5px;">1000 ğŸª™</button>
    </div>
    <div class="shop-item" id="item-seguro">
        <p style="margin:0; font-weight:bold; color:#00ff00;">ğŸ›¡ï¸ Seguro de Ruleta</p>
        <p style="font-size:0.7rem; color:#888;">Te protege de 1 Bancarrota.</p>
        <button id="buy-seguro" onclick="buySeguro()" style="background:#00ff00; color:black; margin-top:5px;">500 ğŸª™</button>
    </div>
    <button onclick="closeModal('shop-modal')" style="background:#444; color:white">CERRAR</button>
</div>

<div id="roulette-modal" class="modal">
    <h3 style="color:gold; margin-top:0;">Ruleta Chistorrita</h3>
    <div id="roulette-display">???</div>
    <button id="spin-btn" onclick="playRoulette()" style="background:gold; color:black;">Â¡GIRAR! (100 ğŸª™)</button>
    <div id="prestamo-section" style="display:none; margin-top:10px;">
        <p style="font-size:0.7rem; color:#ff4444;">Â¿Sin monedas? Chistorrita te presta.</p>
        <button onclick="pedirPrestamo()" style="background:#333; color:white; border:1px solid #ff4444;">Pedir 200 ğŸª™</button>
    </div>
    <button onclick="closeModal('roulette-modal')" style="background:#444; color:white; margin-top:10px;">SALIR</button>
</div>

<script>
// --- NUEVAS VARIABLES DE ESTADO ---
let deuda = parseInt(localStorage.getItem('user_deuda')) || 0;
let tieneSeguro = localStorage.getItem('user_seguro') === 'true';
let rachaSucia = 0; // Contador interno de racha

// --- ACTUALIZAR MONEDAS (Con lÃ³gica de deuda) ---
function addCoins(amount) {
    if (deuda > 0) {
        let pago = Math.min(amount, deuda);
        deuda -= pago;
        amount -= pago;
        localStorage.setItem('user_deuda', deuda);
    }
    coins += amount;
    localStorage.setItem('user_coins', coins);
    updateCoinDisplay();
}

// --- LÃ“GICA DE LA RULETA (Actualizada) ---
function calculateResult() {
    const r = Math.random() * 100;
    const display = document.getElementById('roulette-display');
    let win = 0;

    if (r < 5) { // BANCARROTA 5%
        if (tieneSeguro) {
            display.innerText = "ğŸ›¡ï¸ SEGURO ACTIVADO";
            display.style.color = "#00ff00";
            tieneSeguro = false;
            localStorage.setItem('user_seguro', 'false');
            updateShopUI();
        } else {
            coins = 0;
            rachaSucia = 0;
            display.innerText = "BANCARROTA ğŸ’€";
            display.style.color = "red";
        }
    } else if (r < 15) { // JACKPOT 10% (SubÃ­ un poco la prob)
        win = 1000;
        display.innerText = "Â¡JACKPOT! ğŸ°";
        display.style.color = "gold";
        rachaSucia++;
    } else if (r < 40) { // PREMIO MEDIO 25%
        win = 300;
        display.innerText = "+300 ğŸª™";
        display.style.color = "#39C5BB";
        rachaSucia++;
    } else if (r < 70) { // PREMIO MENOR 30%
        win = 150;
        display.innerText = "+150 ğŸª™";
        display.style.color = "white";
        rachaSucia++;
    } else { // NADA 30%
        display.innerText = "0 - PERDISTE";
        display.style.color = "#444";
        rachaSucia = 0;
    }

    if (win > 0) addCoins(win);
    checkRacha();
    checkPrestamoVis();
    updateCoinDisplay();
}

// --- SISTEMA DE PRESTAMOS ---
function checkPrestamoVis() {
    document.getElementById('prestamo-section').style.display = (coins < 100) ? 'block' : 'none';
}

function pedirPrestamo() {
    if (deuda > 0) return alert("Ya le debes a Chistorrita. Paga primero.");
    deuda = 400; // Debes 400 pero te doy 200
    addCoins(200);
    localStorage.setItem('user_deuda', deuda);
    alert("Chistorrita te prestÃ³ 200 ğŸª™. Pero las prÃ³ximas 400 que ganes irÃ¡n para Ã©l.");
    checkPrestamoVis();
}

// --- SISTEMA DE SEGURO ---
function buySeguro() {
    if(tieneSeguro) return alert("Ya tienes un seguro activo.");
    if(coins >= 500) {
        coins -= 500;
        tieneSeguro = true;
        localStorage.setItem('user_coins', coins);
        localStorage.setItem('user_seguro', 'true');
        updateCoinDisplay();
        updateShopUI();
    } else alert("No tienes suficiente para el seguro.");
}

function updateShopUI() {
    const btn = document.getElementById('buy-seguro');
    const box = document.getElementById('item-seguro');
    if (tieneSeguro) {
        btn.innerText = "ACTIVO";
        box.classList.add('seguro-active');
    } else {
        btn.innerText = "500 ğŸª™";
        box.classList.remove('seguro-active');
    }
}

// --- SISTEMA DE RACHA ---
function checkRacha() {
    const userStatus = document.getElementById('user-status');
    // Eliminar racha anterior si existe
    const oldRacha = document.getElementById('racha-badge');
    if (oldRacha) oldRacha.remove();

    if (rachaSucia >= 3) {
        const span = document.createElement('span');
        span.id = 'racha-badge';
        span.className = 'status-badge racha-fuego';
        span.innerText = `ğŸ”¥ RACHA X${rachaSucia}`;
        userStatus.appendChild(span);
    }
    
    // Si tienes deuda, mostrar badge de deuda
    const oldDeuda = document.getElementById('deuda-badge');
    if (oldDeuda) oldDeuda.remove();
    if (deuda > 0) {
        const dSpan = document.createElement('span');
        dSpan.id = 'deuda-badge';
        dSpan.className = 'status-badge deuda';
        dSpan.innerText = `DEUDA: ${deuda}`;
        userStatus.appendChild(dSpan);
    }
}

// --- MODIFICAR EL UPDATE LOOP ---
// Cambia tu funciÃ³n updateLoop para que use addCoins en lugar de coins +=
function updateLoop() {
    totalSeconds++;
    localStorage.setItem('playtime', totalSeconds);
    if (totalSeconds % 180 === 0) {
        addCoins(hasMultiplier ? 10 : 5);
    }
    // ... resto del cÃ³digo de tiempo ...
    checkRacha(); // Para que se actualice el badge de deuda/racha
}

// --- AL CARGAR ---
// AsegÃºrate de llamar a updateShopUI() y checkRacha() dentro de window.onload
window.onload = () => {
    // ... tus otras cargas ...
    updateShopUI();
    checkRacha();
    checkPrestamoVis();
    updateCoinDisplay();
    render();
};
</script>
